<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>NetPeopleWorld</title>
    <style>
        .chat{
            width: 90%;
            border: dashed 1px #555500;
            padding: 5px;
        }
        .chatBox{
            width: 90%;
            margin-left: 2%;
            margin-right: 2%;
        }
        .messaging{
            margin-left: 2%;
            margin-right: 2%;
        }
        .place{
            bottom: 100px;
        }
    </style>
</head>
<body>
<h1>NetPeopleWorld</h1>

<!--<textarea id="demo" style="border: solid black 1px;resize: none" cols="120" rows="16" readonly="true">Demo</textarea>-->
<div class="chat">
    <textarea class="chatBox" id="chat" style="border: solid black 1px;resize: none;position: relative" cols="50" rows="14" readonly="true">*** Chat ***</textarea><br>
    <div class="messaging">
        <input type="text" id="messageBox" size="56" onkeydown="keyAtMessage()" >
        <input type="button" id="sendMessage" onclick="sendMessage()" value="Отправить">
        <input id="CE" type="radio" onchange="CtrlEnter()" checked>Отсылка на Ctrl+Enter
        <input id="E" type="radio" onchange="Enter()">Отсылка на Enter
    </div>
</div>
<br>Enter a name(ip) of connection target: <input id="ConnectTarget" type="text" size="56" onkeydown="createConnection(this.value);"><br><br>
<div class="place" id="CanvasDiv">
    <canvas id='canvas' style="border: dotted black 3px;"></canvas>
</div>

<script>
    //getting objects from DOM-elements 
    var ce = document.getElementById("CE");
    var e = document.getElementById("E");
    var chatBox = document.getElementById('chat');
    var messageBox = document.getElementById('messageBox');
    var can = document.getElementById('canvas');
    var canDIV = document.getElementById('CanvasDiv');
    var connectionTarget = document.getElementById('ConnectTarget');

    //triggers and key listening
    function CtrlEnter(){
        e.checked = false;
    }

    function Enter(){
        ce.checked = false;
    }

    function keys(){
        //property
        this.whiches = [];

        //functions
        this.down = function(key){
            this.whiches[key] = true;
        };
        this.up = function(key){
            this.whiches[key] = false;
        };
        this.isDown = function(key){
            return (this.whiches[key] == true);
        }
    }

    //Event Listeners 
    document.addEventListener('keydown', function(e){ks.down(e.which);keyChecking()});
    document.addEventListener('keyup', function(e){ks.up(e.which);keyChecking()});
    document.addEventListener("wheel", scaling);
    window.addEventListener('resize', function(e){can.width = canDIV.offsetWidth;ctx = can.getContext('2d');ctx.translate(can.width/2, can.height/2);draw();});


    var offsetX = 0;
    var offsetY = 0;
    var scale = 1;
    var graphScale = 1;
    var graphs;
    var ks = new keys();
    var myPosition;
    var chat = [];

    var offX = 0;
    var offY = 0;
    var r_a = "0.05";
    var color = "rgba(32, 45, 21, " + r_a + ")";
    var ctx = can.getContext('2d');

    can.width = canDIV.offsetWidth;

    var I = {};

    //getting a position
    if (navigator.geolocation) {
        console.log('getting location...');
        navigator.geolocation.getCurrentPosition(sendPosition);
    }
    else alert('Ваше устройство не даёт доступа к геоданным... :(');

    //update the chat state
    chatGetting();

    function sendPosition(pos){
        console.log('sending position...');
        var position = {
            latitude: pos.coords.latitude,
            longitude: pos.coords.longitude
        };
        myPosition = {
            y: position.latitude,
            x: position.longitude
        };
        offsetX = myPosition.x;
        offsetY = myPosition.y;
        console.log(offsetX);
        console.log(offsetY);
        ctx.translate(can.width/2, can.height/2);
        alert('- - Ваши координаты - -\nШирота: ' + position.latitude + '\nДолгота: ' + position.longitude);
        console.log(JSON.stringify(position));
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/newUser', true);
        xhr.send(JSON.stringify(position));

        dataGetting();
    }

    function dataGetting(){
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/updating', true);

        xhr.onload = function(){
            try{
                I = JSON.parse(this.responseText);
            }
            catch (e){
                console.log(e);
                I = {};
            }
            draw();
            setTimeout(dataGetting, 1000);
        };

        xhr.onerror = function(){
            setTimeout(dataGetting, 500);
        };

        xhr.send();
    }

    function createConnection(ip){
        ks.down(window.event.which);
        if (ks.isDown(13)){
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/newConnection', true);
            xhr.onload = function(){
                alert(this.responseText);
            };
            xhr.send(ip.toString());
            connectionTarget.value = "";
        }
    }

    function keyAtMessage(){
        ks.down(window.event.which);
        if (ks.isDown(13)){
            console.log(e.checked);
            if (e.checked == true) {
                sendMessage();
                return;
            }
            if (ks.isDown(17)) sendMessage();
        }
    }

    function sendMessage(){
        if (messageBox.value == "") return;
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/message', true);
        xhr.send(messageBox.value);
        messageBox.value = "";
        chatGetting();
    }

    function chatGetting(){
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/getChatHistory', true);

        xhr.onload = function(){
            var text = '*** Chat ***\n';
            chat = JSON.parse(this.responseText);
            for (var c = chat.length-1; c > 0; c--){
                var mess = chat[c];
                text += (mess.owner + ': ' + mess.message + '\n');
            }
            if (text == messageBox.value) return;
            chatBox.innerHTML = text;
        };

        xhr.onerror = function(){
            setTimeout(chatGetting, 500);
        };

        xhr.send();
    }


    var coeff = 4;
    function keyChecking(){
        /*
         if (ks.isDown(37)) right
         if (ks.isDown(38)) up
         if (ks.isDown(39)) left
         if (ks.isDown(40)) down
         if (ks.isDown(77)) M
         */
    }

    function scaling(wheel){
        var delta = wheel.wheelDelta;
    }

    function draw(){
        if (I == {}) return;
        ctx.clearRect(-can.width/2,-can.height/2,can.width*1.5,can.height*1.5);

        //drawing your graph
        ctx.beginPath();
        ctx.fillStyle = color;
        ctx.strokeStyle = 'red';
        ctx.arc(0, 0, I.size, 0, Math.PI*2, false);
        ctx.fill();
        ctx.stroke();
        ctx.closePath();
        ctx.beginPath();
        ctx.arc(0, 0, 1, Math.PI*2, false);
        ctx.stroke();
        ctx.closePath();
    }

    setInterval(function(){chatGetting();}, 500);
</script>
</body>
</html>